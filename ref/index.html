<!DOCTYPE html>
<html lang="ja-JP">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>NimWorld | 参照</title>
    <meta name="description" content="Nim言語の日本語解説文書">
    
    
    <link rel="preload" href="/Nim-World/assets/css/31.styles.ae5b2834.css" as="style"><link rel="preload" href="/Nim-World/assets/js/app.e7b05814.js" as="script"><link rel="preload" href="/Nim-World/assets/js/8.111bf1fb.js" as="script"><link rel="prefetch" href="/Nim-World/assets/js/16.e79efb54.js"><link rel="prefetch" href="/Nim-World/assets/js/1.d7f873bb.js"><link rel="prefetch" href="/Nim-World/assets/js/2.d9ff731f.js"><link rel="prefetch" href="/Nim-World/assets/js/3.717e8a98.js"><link rel="prefetch" href="/Nim-World/assets/js/4.e073d03b.js"><link rel="prefetch" href="/Nim-World/assets/js/5.a69fa739.js"><link rel="prefetch" href="/Nim-World/assets/js/6.6742b577.js"><link rel="prefetch" href="/Nim-World/assets/js/7.dfb6274e.js"><link rel="prefetch" href="/Nim-World/assets/js/9.e9fec677.js"><link rel="prefetch" href="/Nim-World/assets/js/10.c33e9030.js"><link rel="prefetch" href="/Nim-World/assets/js/11.3fc159fe.js"><link rel="prefetch" href="/Nim-World/assets/js/12.181f3e9f.js"><link rel="prefetch" href="/Nim-World/assets/js/13.ac885d2f.js"><link rel="prefetch" href="/Nim-World/assets/js/14.4c91fcf8.js"><link rel="prefetch" href="/Nim-World/assets/js/15.38de5d4e.js"><link rel="prefetch" href="/Nim-World/assets/js/0.1889d7cc.js"><link rel="prefetch" href="/Nim-World/assets/js/17.f519ebfa.js"><link rel="prefetch" href="/Nim-World/assets/js/18.caeb3f68.js"><link rel="prefetch" href="/Nim-World/assets/js/19.3f02fb3a.js"><link rel="prefetch" href="/Nim-World/assets/js/20.24bfb5e8.js"><link rel="prefetch" href="/Nim-World/assets/js/21.313941d6.js"><link rel="prefetch" href="/Nim-World/assets/js/22.1572028e.js"><link rel="prefetch" href="/Nim-World/assets/js/23.71866a29.js"><link rel="prefetch" href="/Nim-World/assets/js/24.16502deb.js"><link rel="prefetch" href="/Nim-World/assets/js/25.57cd4d7a.js"><link rel="prefetch" href="/Nim-World/assets/js/26.0d6b0264.js"><link rel="prefetch" href="/Nim-World/assets/js/27.0b57af5f.js"><link rel="prefetch" href="/Nim-World/assets/js/28.e75d129d.js"><link rel="prefetch" href="/Nim-World/assets/js/29.60951b50.js"><link rel="prefetch" href="/Nim-World/assets/js/30.3d020f26.js">
    <link rel="stylesheet" href="/Nim-World/assets/css/31.styles.ae5b2834.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/Nim-World/" class="home-link router-link-active"><!----><span class="site-name">
      NimWorld
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><!----></div></header><div class="sidebar-mask"></div><div class="sidebar"><!----><ul class="sidebar-links"><li><a href="/Nim-World/" class="sidebar-link">Introduction</a></li><li><a href="/Nim-World/divetonim/" class="sidebar-link">Dive To Nim 👑</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span></span><span class="arrow right"></span></p><!----></div></li><li><a href="/Nim-World/variable/" class="sidebar-link">変数と定数</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span></span><span class="arrow right"></span></p><!----></div></li><li><a href="/Nim-World/types/" class="sidebar-link">基本データ型</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span></span><span class="arrow right"></span></p><!----></div></li><li><a href="/Nim-World/condition/" class="sidebar-link">条件分岐</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span></span><span class="arrow right"></span></p><!----></div></li><li><a href="/Nim-World/loop/" class="sidebar-link">ループ</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span></span><span class="arrow right"></span></p><!----></div></li><li><a href="/Nim-World/proc/" class="sidebar-link">関数</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span></span><span class="arrow right"></span></p><!----></div></li><li><a href="/Nim-World/ref/" class="active sidebar-link">参照</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Nim-World/ref/#refと型" class="sidebar-link">refと型</a></li><li class="sidebar-sub-header"><a href="/Nim-World/ref/#refとobject型" class="sidebar-link">refとobject型</a></li></ul></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span></span><span class="arrow right"></span></p><!----></div></li><li><a href="/Nim-World/tests/" class="sidebar-link">テスト</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span></span><span class="arrow right"></span></p><!----></div></li><li><a href="/Nim-World/modules/" class="sidebar-link">モジュール</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span></span><span class="arrow right"></span></p><!----></div></li><li><a href="/Nim-World/packages/" class="sidebar-link">パッケージ</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span></span><span class="arrow right"></span></p><!----></div></li><li><a href="/Nim-World/advancednim/" class="sidebar-link">高度なNim</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span></span><span class="arrow right"></span></p><!----></div></li></ul></div><div class="page"><div class="content"><h1 id="参照"><a href="#参照" aria-hidden="true" class="header-anchor">#</a> 参照</h1><p>Nimでは2種類のポインタと呼ばれる物を扱う事ができます。</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>ポインタとは、<strong>ある値が保存されている場所を格納する変数</strong>のことであり、しばしば出てくるポインタ変数の略称のようなものです。</p><p>ちなみに、ある値が保存されている場所の事を<strong>アドレス</strong>と言います。</p></div><p>Nimでポインタを扱うには変数を<code>var</code>で定義しなければなりません。</p><p>しかし、これはアドレスが欲しい変数のみの制約であり、変数のアドレスを格納する変数(ポインタ)は<code>let</code>でも大丈夫です。</p><p><code>ref</code>と<code>ptr</code>の2種類のポインタ型があり、<code>ref</code>はGCが追跡するヒープ内のオブジェクトを指し、使われなくなったら自動的にリソースを解放します。</p><p><code>ptr</code>はGCの管理外のヒープ内のオブジェクトを指すので、私達プログラマーがリソースを使い終わったら解放する必要があり、アンセーフです。</p><p>基本的には<code>ref</code>を使い、メモリとポインタをよく知っている人たちは<code>ptr</code>を使ってもいいでしょう。</p><p>ここでは<code>ref</code>を解説し、<code>ptr</code>やGCについてはまた別の章で解説します。</p><p>ヒープの話も<code>ptr</code>を説明する章で少し詳しく説明するので、そちらも合わせて見てみてください。</p><p>とりあえず今は2種類のポインタがある、ということだけ覚えておきましょう。</p><h2 id="refと型"><a href="#refと型" aria-hidden="true" class="header-anchor">#</a> refと型</h2><p>まずは定義例を見てみましょう。</p><pre class="language-nim"><code><span class="token keyword">var</span> refStr<span class="token operator">:</span> <span class="token keyword">ref</span> string
</code></pre><p>この変数は、<code>string</code>の<code>ref</code>ポインタ変数を宣言しています。</p><p>しかし、まだ値を入れることは出来ません。</p><p>どういう事か実際に見てみましょう。</p><p><code>echo repr refStr</code>とすることでポインタの指し示す場所や値を見ることができます。</p><pre class="language-nim"><code><span class="token keyword">var</span> refStr<span class="token operator">:</span> <span class="token keyword">ref</span> string

echo repr refStr
</code></pre><p><code>nil</code>と表示されましたか？それはバグではなく、正常な物です。</p><p>先程ポインタは値の場所を指し示す物だと言いました。</p><p>つまり、ここでは<strong>場所を記憶する変数</strong>を宣言しただけで、<strong>実際の値が入る場所の確保</strong>が出来ていないのです。</p><p>なので、値を入れる前に、<code>new(string)</code>で<code>string</code>の値が入る場所を確保してあげる必要があります。</p><pre class="language-nim"><code>refStr <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span>
<span class="token comment"># 引数が1つなので、このように書くことも可能</span>
<span class="token comment"># refStr = new string</span>
</code></pre><p>これで<code>string</code>の値を確保し、<code>refStr</code>はその場所を指し示す物となりました。</p><p>先程と同じく<code>echo repr refStr</code>でもう一度見てみましょう。</p><pre class="language-nim"><code><span class="token keyword">var</span> refStr<span class="token operator">:</span> <span class="token keyword">ref</span> string

refStr <span class="token operator">=</span> new string

echo repr refStr
</code></pre><p>おそらく<code>ref 0x英数字の並び --&gt; nil</code>というような物が表示されているはずです。</p><p>ここでの<code>nil</code>は<code>string</code>の初期値なのでまだ文字列が何も無い事を意味します。</p><p><code>ref 0x英数字の並び</code>は、実行するたびに変化します。これは場所の確保をする時に同じ場所を確保することが出来ない場合があるからです。</p><p>ここでは仮に<code>ref 0x12345678</code>とすることにします。この英数字の並びは一般的に<strong>アドレス</strong>と呼ばれます。</p><p>では場所の確保も出来た所で、早速値を入れてみましょう。</p><p>値を入れるには、ポインタが指し示す場所を参照し、値を代入します。</p><p>このポインタが指し示す場所を参照することを<strong>間接参照</strong>や<strong>逆参照</strong>と呼びます。</p><p>値を間接参照するには配列などで使う<code>[]</code>をポインタ変数の後に付けて参照します。</p><pre class="language-nim"><code>refStr<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span>
</code></pre><p>これで<code>refStr</code>が指し示す場所に<code>&quot;test&quot;</code>という文字列が入りました。</p><p><code>echo</code>で表示することができます。</p><pre class="language-nim"><code>echo refStr<span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment"># echo repr refStr</span>
<span class="token comment"># ref 0x12345678 -&gt; ref 0x0abcdefg&quot;test&quot;</span>
<span class="token comment"># 文字列の一番先頭の文字のアドレスを指し示している</span>
</code></pre><p>ここまでで一般的な<code>ref</code>の説明は終わりですが、普通の変数と何が違うのか分かりますか？</p><p>以下のコードを見てみましょう。</p><pre class="language-nim"><code><span class="token keyword">var</span>
  str1 <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span>
  str2 <span class="token operator">=</span> str1

str2 <span class="token operator">=</span> <span class="token string">&quot;aaaa&quot;</span>

echo str1
echo str2
</code></pre><p>何の変哲も無いコードです。<code>str1</code>を<code>str2</code>に入れた後、<code>str2</code>に<code>&quot;aaaa&quot;</code>という文字列を代入しました。</p><p>実行すると<code>test</code>と<code>aaaa</code>が表示されるはずです。</p><p>では次のコードを見てみましょう。</p><pre class="language-nim"><code><span class="token keyword">var</span>
  str1 <span class="token operator">=</span> new string
  str2 <span class="token operator">=</span> str1

str1<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span>
str2<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;aaaa&quot;</span>

echo str1<span class="token punctuation">[</span><span class="token punctuation">]</span>
echo str2<span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre><p>実行すると何が表示されましたか？おそらく二回<code>aaaa</code>が表示されるはずです。</p><p>何故でしょうか？ 私達は<code>str1</code>には確かに<code>test</code>を代入しているはずです。</p><p>ここで普通の変数との違いが出てきます。</p><p><code>str1</code>と<code>str2</code>はどちらも<code>string</code>の値を指し示す変数です。</p><p>つまり<code>str2 = str1</code>はどちらも同じ<code>string</code>の値の場所を指し示す物となります。</p><p>なので、<code>str2</code>の中身を変更すると同じ場所を指し示す<code>str1</code>の値も同じ物になります。</p><p>ここでは<code>str2</code>の指し示す場所の値を<code>aaaa</code>に変更したため、同じ場所を指し示す<code>str1</code>の中身も<code>aaaa</code>になっているのです。</p><p>この挙動が何で役に立つかというと、例えば関数の引数に使う例があります。</p><p>通常、関数の引数に渡す値は、コピーが発生します。</p><p>Nimでは通常参照渡しとなり、コピーが発生しません。しかし、渡された値を編集した時点でコピーされてしまします。</p><p>仮に巨大なサイズのオブジェクトがあってそれを関数内部で編集する関数があったとしましょう。</p><p>関数に渡して編集した時点で値がコピーされるので巨大なサイズのオブジェクトがもう一つできる事になります。</p><p>これが数回程度ならいいかもしれませんが、数千回、数万回となってくるとどうでしょうか？</p><p>ここで巨大なサイズのオブジェクトを指し示すポインタ変数を用意して、その変数を関数に渡すとどうでしょうか？</p><p>ここで発生するコピーはアドレスの数値のみです。中身は間接参照して取得することが出来ますよね。</p><p>つまり、値をコピーしたくないので、関数に値を渡す代わりに<code>ref T</code>を渡せば値のコピーがなくなり、処理速度が向上する、ということになります。</p><p>ただし、渡した<code>ref T</code>が指し示す値を直接変更したりする操作がある場合、</p><p>関数の外で他にも同じ場所を指し示すポインタ変数がある場合などで注意が必要です。</p><h2 id="refとobject型"><a href="#refとobject型" aria-hidden="true" class="header-anchor">#</a> refとobject型</h2><p><code>ref</code>を<code>object</code>で扱う事は通常の<code>ref</code>の使用とほぼ同じです。</p><p><code>object</code>は<code>type</code>ステートメントで宣言しますが、ここで<code>ref</code>を使うのと<code>new object</code>をするのとでは少し違います。</p><p>まずは以下のコードを見てみましょう。</p><p>それぞれ関数内部でオブジェクトを作成し、それを返り値としています。</p><pre class="language-nim"><code><span class="token keyword">type</span>
  Obj <span class="token operator">=</span> <span class="token keyword">object</span>
    name<span class="token operator">:</span> string

  ObjRef <span class="token operator">=</span> <span class="token keyword">ref</span> Obj

  ObjRef2 <span class="token operator">=</span> <span class="token keyword">ref</span> <span class="token keyword">object</span>
    name<span class="token operator">:</span> string

<span class="token keyword">proc</span> <span class="token function">oCreate1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Obj <span class="token operator">=</span>
  <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token function">Obj</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token string">&quot;john&quot;</span><span class="token punctuation">)</span>
  echo repr o
  <span class="token keyword">return</span> o

<span class="token keyword">proc</span> <span class="token function">oCreate2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ObjRef <span class="token operator">=</span>
  <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token function">ObjRef</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token string">&quot;sam&quot;</span><span class="token punctuation">)</span>
  echo repr o
  <span class="token keyword">return</span> o

<span class="token keyword">proc</span> <span class="token function">oCreate3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ObjRef2 <span class="token operator">=</span>
  <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token function">ObjRef2</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token string">&quot;2vg&quot;</span><span class="token punctuation">)</span>
  echo repr o
  <span class="token keyword">return</span> o

<span class="token keyword">proc</span> <span class="token function">oCreate4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">ref</span> Obj <span class="token operator">=</span>
  <span class="token keyword">var</span> o <span class="token operator">=</span> new Obj
  o<span class="token operator">.</span>name <span class="token operator">=</span> <span class="token string">&quot;mofu&quot;</span>
  echo repr o
  <span class="token keyword">return</span> o

<span class="token keyword">var</span>
  o1 <span class="token operator">=</span> <span class="token function">oCreate1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  o2 <span class="token operator">=</span> <span class="token function">oCreate2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  o3 <span class="token operator">=</span> <span class="token function">oCreate3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  o4 <span class="token operator">=</span> <span class="token function">oCreate4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

echo <span class="token string">&quot;\n--------\n&quot;</span>

echo repr o1
echo repr o2
echo repr o3
echo repr o4
</code></pre><p>実行すると気づいた事があると思います。</p><p><code>oCreate1</code>で作成されたオブジェクトは関数内のアドレスと関数の返り値でもらったオブジェクトは別々のアドレスになっていると思います。
しかし、<code>oCreat2</code>から<code>oCreat4</code>は関数内のアドレスと同じです。</p><p>違いが分かりますか？</p><p><code>oCreat1</code>で作られる<code>Obj</code>は関数内のスタックに作成されるのに対し、<code>ObjRef</code>、 <code>ObjRef2</code>、<code>ref Obj</code>はどれもヒープ内に作成されます。</p><p>そのため、通常の<code>object</code>は関数を超えてアクセスできませんが、<code>ref</code>が付随すると関数を超えてオブジェクトにアクセスすることができるのです。</p><p><code>ref</code>を付随してヒープに作られたオブジェクトは、</p><p>どこの変数からも参照がなくなったりして使われなくなると自動的に解放されるため、私たちは通常通りにコードを書くだけで良いのです。</p></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/Nim-World/proc/" class="prev">
          関数
        </a></span><span class="next"><a href="/Nim-World/tests/">
          テスト
        </a> →
      </span></p></div></div></div></div>
    <script src="/Nim-World/assets/js/8.111bf1fb.js" defer></script><script src="/Nim-World/assets/js/app.e7b05814.js" defer></script>
  </body>
</html>
